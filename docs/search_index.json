[
["index.html", "R, Databases &amp; SQL Preface Structure of the book Software information", " R, Databases &amp; SQL Aravind Hebbali 2019-02-13 Preface This work is licensed under a Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License. Structure of the book Chapter 1 introduces the DBI package. Chapter 2 explores data wrangling within database using the dplyr package. Chapters 3 and 4 introduce basic and advanced SQL. Software information The R session information when compiling this book is shown below: sessionInfo() ## R version 3.5.1 (2018-07-02) ## Platform: x86_64-w64-mingw32/x64 (64-bit) ## Running under: Windows 10 x64 (build 17134) ## ## Matrix products: default ## ## locale: ## [1] LC_COLLATE=English_India.1252 LC_CTYPE=English_India.1252 ## [3] LC_MONETARY=English_India.1252 LC_NUMERIC=C ## [5] LC_TIME=English_India.1252 ## ## attached base packages: ## [1] stats graphics grDevices utils datasets methods base ## ## loaded via a namespace (and not attached): ## [1] compiler_3.5.1 magrittr_1.5 bookdown_0.7 tools_3.5.1 ## [5] htmltools_0.3.6 rstudioapi_0.8 yaml_2.2.0 Rcpp_1.0.0 ## [9] stringi_1.2.4 rmarkdown_1.11 knitr_1.21 stringr_1.3.1 ## [13] xfun_0.4 digest_0.6.18 evaluate_0.12 We do not add prompts (&gt; and +) to R source code in this book, and we comment out the text output with two hashes ## by default, as you can see from the R session information above. This is for your convenience when you want to copy and run the code (the text output will be ignored since it is commented out). Package names are in bold text (e.g., rmarkdown), and function names are followed by parentheses (e.g., bookdown::render_book()). The double-colon operator :: means accessing an object from a package. "],
["about-the-author.html", "About the Author", " About the Author Aravind Hebbali is the founder of Rsquared Academy. He earned his Masters in Economics from Madras School of Economics. As an active R user, he has authored several R packages such as olsrr rfm descriptr blorr xplorerr In 2015, he founded Rsquared Academy, a free and open source education initiative with focus on data science and analytics. Apart from self paced online courses, Rsquared Academy offers customized learning modules for corporates and universities. You can find him on GitHub. "],
["dbi.html", "Chapter 1 DBI 1.1 Introduction 1.2 Libraries, Code &amp; Data 1.3 Connection 1.4 Querying Data 1.5 Query 1.6 Create Table 1.7 Append Data 1.8 Insert Rows 1.9 Remove Table 1.10 SQLite Data Type 1.11 Close Connection", " Chapter 1 DBI 1.1 Introduction In this chapter, we will learn to: connect to a SQLite database from R display database information list tables in the database query data read entire table read few rows read data in batches create table in database overwrite table in database append data to table in database remove table from database generate SQL query close database connection 1.2 Libraries, Code &amp; Data We will use the following libraries: DBI RSQLite All the data sets used in this chapter can be found here and code can be downloaded from here. 1.3 Connection The first step is to connect to a database. We will connect to an in memory SQLite databse using dbConnect(). con &lt;- dbConnect(RSQLite::SQLite(), &quot;:memory:&quot;) 1.3.1 Connection Summary We can get the more information about the connection using summary(). summary(con) ## Length Class Mode ## 1 SQLiteConnection S4 1.3.2 List Tables Now that we are connected to a database, let us list all the tables present in it using dbListTables(). dbListTables(con) ## [1] &quot;ecom&quot; &quot;sqlite_stat1&quot; &quot;sqlite_stat4&quot; 1.3.3 List Fields Time to explore the ecom table in the database. Use dbListFields() to list all the fields in the table. dbListFields(con, &quot;ecom&quot;) ## [1] &quot;referrer&quot; &quot;device&quot; &quot;bouncers&quot; &quot;n_visit&quot; &quot;n_pages&quot; &quot;duration&quot; 1.4 Querying Data The main objectives of connecting to a database are to: query data from the tables already present create new tables overwrite existing tables delete existing tables Let us begin with querying data. We can do this in the following ways: read an entire table at once read few rows from a table read data in batches 1.4.1 Entire Table We can read an entire table from a database using dbReadTable(). dbReadTable(con, &#39;ecom&#39;) ## referrer device bouncers n_visit n_pages duration ## 1 google laptop 1 10 1 693 ## 2 yahoo tablet 1 9 1 459 ## 3 direct laptop 1 0 1 996 ## 4 bing tablet 0 3 18 468 ## 5 yahoo mobile 1 9 1 955 ## 6 yahoo laptop 0 5 5 135 ## 7 yahoo mobile 1 10 1 75 ## 8 direct mobile 1 10 1 908 ## 9 bing mobile 0 3 19 209 ## 10 google mobile 1 6 1 208 ## 11 direct laptop 1 9 1 738 ## 12 direct tablet 0 6 12 132 ## 13 direct mobile 0 9 14 406 ## 14 yahoo tablet 0 5 8 80 ## 15 yahoo mobile 0 7 1 19 ## 16 bing laptop 1 1 1 995 ## 17 bing tablet 0 5 16 368 ## 18 google tablet 1 7 1 406 ## 19 social tablet 0 7 10 290 ## 20 social tablet 0 2 1 28 In some cases, we may not need the entire table but only a specific number of rows. Use dbGetQuery() and supply a SQL statement specifying the number of rows of data to be read from the table. In the below example, we read ten rows of data from the ecom table. 1.4.2 Few Rows dbGetQuery(con, &quot;select * from ecom limit 10&quot;) ## referrer device bouncers n_visit n_pages duration ## 1 google laptop 1 10 1 693 ## 2 yahoo tablet 1 9 1 459 ## 3 direct laptop 1 0 1 996 ## 4 bing tablet 0 3 18 468 ## 5 yahoo mobile 1 9 1 955 ## 6 yahoo laptop 0 5 5 135 ## 7 yahoo mobile 1 10 1 75 ## 8 direct mobile 1 10 1 908 ## 9 bing mobile 0 3 19 209 ## 10 google mobile 1 6 1 208 In case of very large table, we can read data in batches using dbSendQuery() and dbFetch(). We can mention the number of rows of data to be read while fetching the data using the query generated by dbGetQuery(). 1.4.3 Read Data in Batches query &lt;- dbSendQuery(con, &#39;select * from ecom&#39;) result &lt;- dbFetch(query, n = 15) result ## referrer device bouncers n_visit n_pages duration ## 1 google laptop 1 10 1 693 ## 2 yahoo tablet 1 9 1 459 ## 3 direct laptop 1 0 1 996 ## 4 bing tablet 0 3 18 468 ## 5 yahoo mobile 1 9 1 955 ## 6 yahoo laptop 0 5 5 135 ## 7 yahoo mobile 1 10 1 75 ## 8 direct mobile 1 10 1 908 ## 9 bing mobile 0 3 19 209 ## 10 google mobile 1 6 1 208 ## 11 direct laptop 1 9 1 738 ## 12 direct tablet 0 6 12 132 ## 13 direct mobile 0 9 14 406 ## 14 yahoo tablet 0 5 8 80 ## 15 yahoo mobile 0 7 1 19 1.5 Query 1.5.1 Query Status To know the status of a query, use dbHasCompleted(). It is very useful in cases of queries that might take a long time to complete. dbHasCompleted(query) ## [1] FALSE 1.5.2 Query Info dbGetInfo() will return the following: the sql staement number of rows fetched number of rows modified/affected status of the query dbGetInfo(query) ## $statement ## [1] &quot;select * from ecom&quot; ## ## $row.count ## [1] 15 ## ## $rows.affected ## [1] 0 ## ## $has.completed ## [1] FALSE 1.5.3 Latest Query To get the latest query, use dbGetStatement(). dbGetStatement(query) ## [1] &quot;select * from ecom&quot; 1.5.4 Rows Fetched To check the number of rows of data returned by a query, use dbGetRowCount(). dbGetRowCount(query) ## [1] 15 1.5.5 Rows Affected To know the number of rows modified or affected in the table, use dbGetRowsAffected(). dbGetRowsAffected(query) ## [1] 0 1.5.6 Column Info To know the name of the columns and their data types, use dbColumnInfo(). dbColumnInfo(query) ## name type ## 1 referrer character ## 2 device character ## 3 bouncers integer ## 4 n_visit double ## 5 n_pages double ## 6 duration double 1.6 Create Table So far we have explored querying data from an existing table. Now, let us turn our attention to creating new tables in the database. 1.6.0.1 Introduction To create a new table, use dbWriteTable(). It takes the following 3 arguments: connection name name of the new table data for the new table x &lt;- 1:10 y &lt;- letters[1:10] trial &lt;- tibble::tibble(x, y) dbWriteTable(con, &quot;trial&quot;, trial) ## Warning: Closing open result set, pending rows Let us check if the new table has been created. dbListTables(con) ## [1] &quot;ecom&quot; &quot;sqlite_stat1&quot; &quot;sqlite_stat4&quot; &quot;trial&quot; dbExistsTable(con, &quot;trial&quot;) ## [1] TRUE Let us query data from the new table. dbGetQuery(con, &quot;select * from trial limit 5&quot;) ## x y ## 1 1 a ## 2 2 b ## 3 3 c ## 4 4 d ## 5 5 e 1.6.0.2 Overwrite Table In some cases, you may want to overwrite the data in an existing table. Use the overwrite argument in dbWriteTable() and set it to TRUE. x &lt;- sample(100, 10) y &lt;- letters[11:20] trial2 &lt;- tibble::tibble(x, y) dbWriteTable(con, &quot;trial&quot;, trial2, overwrite = TRUE) Let us see if the trial table has been overwritten. dbGetQuery(con, &quot;select * from trial limit 5&quot;) ## x y ## 1 82 k ## 2 51 l ## 3 38 m ## 4 83 n ## 5 75 o 1.7 Append Data You can append data to an existing table by setting the append argument in dbWriteTable() to TRUE. x &lt;- sample(100, 10) y &lt;- letters[5:14] trial3 &lt;- tibble::tibble(x, y) dbWriteTable(con, &quot;trial&quot;, trial3, append = TRUE) Let us quickly check if the new data has been appended to the trial table. dbReadTable(con, &quot;trial&quot;) ## x y ## 1 82 k ## 2 51 l ## 3 38 m ## 4 83 n ## 5 75 o ## 6 93 p ## 7 7 q ## 8 52 r ## 9 84 s ## 10 41 t ## 11 37 e ## 12 31 f ## 13 78 g ## 14 16 h ## 15 22 i ## 16 88 j ## 17 68 k ## 18 30 l ## 19 9 m ## 20 41 n We can also use sqlAppendTable() to append data to an existing table. sqlAppendTable(con, &quot;ecom&quot;, head(ecom)) ## Warning: Do not rely on the default value of the row.names argument for ## sqlAppendTable(), it will change in the future. ## &lt;SQL&gt; INSERT INTO `ecom` ## (`referrer`, `device`, `bouncers`, `n_visit`, `n_pages`, `duration`) ## VALUES ## (&#39;google&#39;, &#39;laptop&#39;, TRUE, 10, 1, 693), ## (&#39;yahoo&#39;, &#39;tablet&#39;, TRUE, 9, 1, 459), ## (&#39;direct&#39;, &#39;laptop&#39;, TRUE, 0, 1, 996), ## (&#39;bing&#39;, &#39;tablet&#39;, FALSE, 3, 18, 468), ## (&#39;yahoo&#39;, &#39;mobile&#39;, TRUE, 9, 1, 955), ## (&#39;yahoo&#39;, &#39;laptop&#39;, FALSE, 5, 5, 135) 1.8 Insert Rows 1.8.0.1 Introduction We can insert new rows into existing tables using: dbExecute() dbSendStatement() Both the function take 2 arguments: connection name sql statement # use dbExecute dbExecute(con, &quot;INSERT into trial (x, y) VALUES (32, &#39;c&#39;), (45, &#39;k&#39;), (61, &#39;h&#39;)&quot; ) ## [1] 3 # use dbSendStatement dbSendStatement(con, &quot;INSERT into trial (x, y) VALUES (25, &#39;m&#39;), (54, &#39;l&#39;), (16, &#39;y&#39;)&quot; ) ## &lt;SQLiteResult&gt; ## SQL INSERT into trial (x, y) VALUES (25, &#39;m&#39;), (54, &#39;l&#39;), (16, &#39;y&#39;) ## ROWS Fetched: 0 [complete] ## Changed: 3 1.9 Remove Table If you want to delete/remove a table from the database, use dbRemoveTable(). dbRemoveTable(con, &quot;trial&quot;) ## Warning: Closing open result set, pending rows 1.10 SQLite Data Type If you want to know the data type, use dbDataType(). dbDataType(RSQLite::SQLite(), &quot;a&quot;) ## [1] &quot;TEXT&quot; dbDataType(RSQLite::SQLite(), 1:5) ## [1] &quot;INTEGER&quot; dbDataType(RSQLite::SQLite(), 1.5) ## [1] &quot;REAL&quot; 1.11 Close Connection It is a good practice to close connection to a database when you no longer need to read/write data from/to it. Use dbDisconnect() to close the database connection. dbDisconnect(con) "],
["dbplyr.html", "Chapter 2 dbplyr 2.1 Introduction 2.2 Libraries, Code &amp; Data 2.3 Connect to Database 2.4 Reference Data 2.5 Query Data 2.6 Show Query 2.7 Collect Data", " Chapter 2 dbplyr 2.1 Introduction In this chapter, we will learn to query data from a database using dplyr. 2.2 Libraries, Code &amp; Data We will use the following libraries: DBI RSQLite dbplyr dplyr All the data sets used in this chapter can be found here and code can be downloaded from here. 2.3 Connect to Database Let us connect to an in memory SQLite database using dbConnect(). con &lt;- dbConnect(RSQLite::SQLite(), &quot;:memory:&quot;) We will copy the mtcars data to the database so that we can use it for running dplyr statements. dplyr::copy_to(con, mtcars) 2.4 Reference Data In order to use dplyr functions, we need to reference the table in the database using tbl(). mtcars2 &lt;- dplyr::tbl(con, &quot;mtcars&quot;) mtcars2 ## # Source: table&lt;mtcars&gt; [?? x 11] ## # Database: sqlite 3.22.0 [:memory:] ## mpg cyl disp hp drat wt qsec vs am gear carb ## &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; ## 1 21 6 160 110 3.9 2.62 16.5 0 1 4 4 ## 2 21 6 160 110 3.9 2.88 17.0 0 1 4 4 ## 3 22.8 4 108 93 3.85 2.32 18.6 1 1 4 1 ## 4 21.4 6 258 110 3.08 3.22 19.4 1 0 3 1 ## 5 18.7 8 360 175 3.15 3.44 17.0 0 0 3 2 ## 6 18.1 6 225 105 2.76 3.46 20.2 1 0 3 1 ## 7 14.3 8 360 245 3.21 3.57 15.8 0 0 3 4 ## 8 24.4 4 147. 62 3.69 3.19 20 1 0 4 2 ## 9 22.8 4 141. 95 3.92 3.15 22.9 1 0 4 2 ## 10 19.2 6 168. 123 3.92 3.44 18.3 1 0 4 4 ## # ... with more rows 2.5 Query Data We will look at some simple examples. Let us start by selecting mpg, cyl and drat columns from mtcars2. select(mtcars2, mpg, cyl, drat) ## # Source: lazy query [?? x 3] ## # Database: sqlite 3.22.0 [:memory:] ## mpg cyl drat ## &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; ## 1 21 6 3.9 ## 2 21 6 3.9 ## 3 22.8 4 3.85 ## 4 21.4 6 3.08 ## 5 18.7 8 3.15 ## 6 18.1 6 2.76 ## 7 14.3 8 3.21 ## 8 24.4 4 3.69 ## 9 22.8 4 3.92 ## 10 19.2 6 3.92 ## # ... with more rows We can filter data as well. Filter all the rows from mtcars2 where mpg is greater than 25. filter(mtcars2, mpg &gt; 25) ## # Source: lazy query [?? x 11] ## # Database: sqlite 3.22.0 [:memory:] ## mpg cyl disp hp drat wt qsec vs am gear carb ## &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; ## 1 32.4 4 78.7 66 4.08 2.2 19.5 1 1 4 1 ## 2 30.4 4 75.7 52 4.93 1.62 18.5 1 1 4 2 ## 3 33.9 4 71.1 65 4.22 1.84 19.9 1 1 4 1 ## 4 27.3 4 79 66 4.08 1.94 18.9 1 1 4 1 ## 5 26 4 120. 91 4.43 2.14 16.7 0 1 5 2 ## 6 30.4 4 95.1 113 3.77 1.51 16.9 1 1 5 2 Time to do some grouping and summarizing. Let us compute the average mileage for different types of cylinders. mtcars2 %&gt;% group_by(cyl) %&gt;% summarise(mileage = mean(mpg)) ## Warning: Missing values are always removed in SQL. ## Use `AVG(x, na.rm = TRUE)` to silence this warning ## # Source: lazy query [?? x 2] ## # Database: sqlite 3.22.0 [:memory:] ## cyl mileage ## &lt;dbl&gt; &lt;dbl&gt; ## 1 4 26.7 ## 2 6 19.7 ## 3 8 15.1 2.6 Show Query If you want to view the SQL query generated in the above step, use show_query() or explain(). mileages &lt;- mtcars2 %&gt;% group_by(cyl) %&gt;% summarise(mileage = mean(mpg)) dplyr::show_query(mileages) ## Warning: Missing values are always removed in SQL. ## Use `AVG(x, na.rm = TRUE)` to silence this warning ## &lt;SQL&gt; ## SELECT `cyl`, AVG(`mpg`) AS `mileage` ## FROM `mtcars` ## GROUP BY `cyl` dplyr::explain(mileages) ## Warning: Missing values are always removed in SQL. ## Use `AVG(x, na.rm = TRUE)` to silence this warning ## &lt;SQL&gt; ## SELECT `cyl`, AVG(`mpg`) AS `mileage` ## FROM `mtcars` ## GROUP BY `cyl` ## ## Warning: Missing values are always removed in SQL. ## Use `AVG(x, na.rm = TRUE)` to silence this warning ## &lt;PLAN&gt; ## addr opcode p1 p2 p3 p4 p5 comment ## 1 0 Init 0 43 0 00 NA ## 2 1 SorterOpen 1 2 0 k(1,B) 00 NA ## 3 2 Integer 0 5 0 00 NA ## 4 3 Integer 0 4 0 00 NA ## 5 4 Null 0 8 8 00 NA ## 6 5 Gosub 7 40 0 00 NA ## 7 6 OpenRead 0 2 1 2 00 NA ## 8 7 Rewind 0 15 0 00 NA ## 9 8 Column 0 1 10 00 NA ## 10 9 RealAffinity 10 0 0 00 NA ## 11 10 Column 0 0 11 00 NA ## 12 11 RealAffinity 11 0 0 00 NA ## 13 12 MakeRecord 10 2 12 00 NA ## 14 13 SorterInsert 1 12 0 00 NA ## 15 14 Next 0 8 0 01 NA ## 16 15 OpenPseudo 2 12 2 00 NA ## 17 16 SorterSort 1 42 0 00 NA ## 18 17 SorterData 1 12 2 00 NA ## 19 18 Column 2 0 9 00 NA ## 20 19 Compare 8 9 1 k(1,B) 00 NA ## 21 20 Jump 21 25 21 00 NA ## 22 21 Move 9 8 1 00 NA ## 23 22 Gosub 6 34 0 00 NA ## 24 23 IfPos 5 42 0 00 NA ## 25 24 Gosub 7 40 0 00 NA ## 26 25 Column 2 1 13 00 NA ## 27 26 AggStep0 0 13 2 avg(1) 01 NA ## 28 27 Column 2 0 1 00 NA ## 29 28 Integer 1 4 0 00 NA ## 30 29 SorterNext 1 17 0 00 NA ## 31 30 Gosub 6 34 0 00 NA ## 32 31 Goto 0 42 0 00 NA ## 33 32 Integer 1 5 0 00 NA ## 34 33 Return 6 0 0 00 NA ## 35 34 IfPos 4 36 0 00 NA ## 36 35 Return 6 0 0 00 NA ## 37 36 AggFinal 2 1 0 avg(1) 00 NA ## 38 37 Copy 1 14 1 00 NA ## 39 38 ResultRow 14 2 0 00 NA ## 40 39 Return 6 0 0 00 NA ## 41 40 Null 0 1 3 00 NA ## 42 41 Return 7 0 0 00 NA ## 43 42 Halt 0 0 0 00 NA ## 44 43 Transaction 1 0 2 0 01 NA ## 45 44 Goto 0 1 0 00 NA 2.7 Collect Data Now, some interesting facts. When working with databases, dplyr never pulls data into R unless you explicitly ask for it. In the previous example, dplyr will not do anything until you ask for the mileages data. It generates the SQL and only pulls down a few rows when you try to print mileages. So how do we pull all the data and store it for further analysis? collect() will pull all the data and store it in a tibble and you can use it for any further analysis. dplyr::collect(mileages) ## Warning: Missing values are always removed in SQL. ## Use `AVG(x, na.rm = TRUE)` to silence this warning ## # A tibble: 3 x 2 ## cyl mileage ## &lt;dbl&gt; &lt;dbl&gt; ## 1 4 26.7 ## 2 6 19.7 ## 3 8 15.1 "],
["sqlbasics.html", "Chapter 3 SQL Basics 3.1 Introduction 3.2 Libraries, Code &amp; Data 3.3 Set Up 3.4 Select Columns 3.5 Limit 3.6 Distinct 3.7 Filter 3.8 And, Or &amp; Not 3.9 BETWEEN 3.10 IN 3.11 IS NULL 3.12 LIKE", " Chapter 3 SQL Basics 3.1 Introduction In this chapter, we will learn to: select single column multiple columns distinct values in a column limit the number of records returned handle NULL values and filter columns using the following operators WHERE AND, or &amp; NOT BETWEEN IN LIKE 3.2 Libraries, Code &amp; Data We will use the following libraries: DBI RSQLite dbplyr All the data sets used in this chapter can be found here and code can be downloaded from here. 3.3 Set Up ecom &lt;- readr::read_csv(&#39;https://raw.githubusercontent.com/rsquaredacademy/datasets/master/web.csv&#39;) con &lt;- DBI::dbConnect(RSQLite::SQLite(), &quot;:memory:&quot;) copy_to(con, ecom) 3.4 Select Columns The SQL SELECT statement is used to fetch the data from a database table. 3.4.1 Syntax Below is the basic syntax of the SELECT statement. SELECT column1, column2, columnN FROM table_name; Here, column1, column2… are the fields of a table whose values you want to fetch. If you want to fetch all the fields, use the following syntax. SELECT * FROM table_name; 3.4.2 Select Single Column Let us begin by selecting the device field from the ecom table. dbGetQuery(con, &quot;SELECT device FROM ecom&quot;) ## device ## 1 laptop ## 2 tablet ## 3 laptop ## 4 tablet ## 5 mobile ## 6 laptop ## 7 mobile ## 8 mobile ## 9 mobile ## 10 mobile ## 11 laptop ## 12 tablet ## 13 mobile ## 14 tablet ## 15 mobile ## 16 laptop ## 17 tablet ## 18 tablet ## 19 tablet ## 20 tablet ## 21 laptop ## 22 mobile ## 23 mobile ## 24 laptop ## 25 laptop ## 26 laptop ## 27 tablet ## 28 laptop ## 29 mobile ## 30 mobile ## 31 tablet ## 32 mobile ## 33 laptop ## 34 tablet ## 35 mobile ## 36 mobile ## 37 laptop ## 38 mobile ## 39 mobile ## 40 mobile ## 41 mobile ## 42 mobile ## 43 laptop ## 44 tablet ## 45 laptop ## 46 tablet ## 47 mobile ## 48 laptop ## 49 mobile ## 50 tablet ## [ reached getOption(&quot;max.print&quot;) -- omitted 950 rows ] 3.4.3 Select Multiple Columns Select the following fields from the ecom table: referrer device purchase dbGetQuery(con, &quot;SELECT referrer, device, purchase FROM ecom&quot;) ## referrer device purchase ## 1 google laptop 0 ## 2 yahoo tablet 0 ## 3 direct laptop 0 ## 4 bing tablet 1 ## 5 yahoo mobile 0 ## 6 yahoo laptop 0 ## 7 yahoo mobile 0 ## 8 direct mobile 0 ## 9 bing mobile 0 ## 10 google mobile 0 ## 11 direct laptop 0 ## 12 direct tablet 0 ## 13 direct mobile 1 ## 14 yahoo tablet 0 ## 15 yahoo mobile 0 ## 16 bing laptop 0 ## [ reached getOption(&quot;max.print&quot;) -- omitted 984 rows ] 3.4.4 Select All Columns Select all the fields from the ecom table. dbGetQuery(con, &quot;SELECT * FROM ecom&quot;) ## id referrer device bouncers n_visit n_pages duration ## 1 1 google laptop 1 10 1 693 ## 2 2 yahoo tablet 1 9 1 459 ## 3 3 direct laptop 1 0 1 996 ## 4 4 bing tablet 0 3 18 468 ## country purchase order_items order_value ## 1 Czech Republic 0 0 0 ## 2 Yemen 0 0 0 ## 3 Brazil 0 0 0 ## 4 China 1 6 434 ## [ reached getOption(&quot;max.print&quot;) -- omitted 996 rows ] 3.5 Limit If you have a large table with thousands of rows, returning all the records will take time. Use LIMIT to specify the number of records to return. dbGetQuery(con, &quot;SELECT * FROM ecom limit 10&quot;) ## id referrer device bouncers n_visit n_pages duration country ## 1 1 google laptop 1 10 1 693 Czech Republic ## 2 2 yahoo tablet 1 9 1 459 Yemen ## 3 3 direct laptop 1 0 1 996 Brazil ## 4 4 bing tablet 0 3 18 468 China ## purchase order_items order_value ## 1 0 0 0 ## 2 0 0 0 ## 3 0 0 0 ## 4 1 6 434 ## [ reached getOption(&quot;max.print&quot;) -- omitted 6 rows ] 3.6 Distinct A column in a table may often contain many duplicate values; and we might be interested only in the distinct/unique values. In such cases, we can use the SELECT DISTINCT statement to return only distinct values. dbGetQuery(con, &quot;SELECT distinct referrer FROM ecom&quot;) ## referrer ## 1 google ## 2 yahoo ## 3 direct ## 4 bing ## 5 social 3.7 Filter Now that we know how to select columns, let us focus on filtering data. In SQL, the WHERE keyword is used to extract only those records that fulfill a specified condition. Data filter based on both text and numeric values in a table. Below are a few comparison operators we can use: = equal &lt;&gt; not equal &lt; less than &gt; greater than &lt;= less than or equal to &gt;= greater than or equal to The following SQL statement filters all rows from the ecom table where the duration field is greater than 300. dbGetQuery(con, &quot;SELECT * FROM ecom WHERE duration &gt; 300&quot;) ## id referrer device bouncers n_visit n_pages duration ## 1 1 google laptop 1 10 1 693 ## 2 2 yahoo tablet 1 9 1 459 ## 3 3 direct laptop 1 0 1 996 ## 4 4 bing tablet 0 3 18 468 ## country purchase order_items order_value ## 1 Czech Republic 0 0 0 ## 2 Yemen 0 0 0 ## 3 Brazil 0 0 0 ## 4 China 1 6 434 ## [ reached getOption(&quot;max.print&quot;) -- omitted 472 rows ] Let us filter data based on a text value. In the following example, we filter all rows from the ecom table where the device used is mobile. dbGetQuery(con, &quot;SELECT * FROM ecom WHERE device == &#39;mobile&#39;&quot;) ## id referrer device bouncers n_visit n_pages duration ## 1 5 yahoo mobile 1 9 1 955 ## 2 7 yahoo mobile 1 10 1 75 ## 3 8 direct mobile 1 10 1 908 ## 4 9 bing mobile 0 3 19 209 ## country purchase order_items order_value ## 1 Poland 0 0 0 ## 2 Bangladesh 0 0 0 ## 3 Indonesia 0 0 0 ## 4 Netherlands 0 0 0 ## [ reached getOption(&quot;max.print&quot;) -- omitted 340 rows ] 3.8 And, Or &amp; Not The WHERE clause can be combined with other operators such as AND - displays a record if all the conditions separated by AND is TRUE OR - displays a record if any of the conditions separated by OR is TRUE NOT - displays a record if the condition(s) is NOT TRUE to filter data based on more than one condition or to create more complex conditions. In the following example, we filter all the rows from the ecom table where n_visit (visit count) is greater than 3 and duration (time spent on the site) is greater than 100. We use AND to create multiple conditions. dbGetQuery(con, &quot;SELECT * FROM ecom WHERE n_visit &gt; 3 AND duration &gt; 100&quot;) ## id referrer device bouncers n_visit n_pages duration ## 1 1 google laptop 1 10 1 693 ## 2 2 yahoo tablet 1 9 1 459 ## 3 5 yahoo mobile 1 9 1 955 ## 4 6 yahoo laptop 0 5 5 135 ## country purchase order_items order_value ## 1 Czech Republic 0 0 0 ## 2 Yemen 0 0 0 ## 3 Poland 0 0 0 ## 4 South Africa 0 0 0 ## [ reached getOption(&quot;max.print&quot;) -- omitted 509 rows ] In the next example, we will use both AND &amp; OR. Our goal is to filter all rows from the ecom table that follow the below conditions: n_visit (visit count) is either equal to 3 or 5 device used to visit the website is either mobile or tablet dbGetQuery(con, &quot;SELECT * FROM ecom WHERE (n_visit == 5 OR n_visit == 3) AND (device = &#39;mobile&#39; OR device = &#39;tablet&#39;)&quot;) ## id referrer device bouncers n_visit n_pages duration ## 1 4 bing tablet 0 3 18 468 ## 2 9 bing mobile 0 3 19 209 ## 3 14 yahoo tablet 0 5 8 80 ## 4 17 bing tablet 0 5 16 368 ## country purchase order_items order_value ## 1 China 1 6 434 ## 2 Netherlands 0 0 0 ## 3 Philippines 0 2 362 ## 4 Peru 1 6 1049 ## [ reached getOption(&quot;max.print&quot;) -- omitted 130 rows ] 3.9 BETWEEN The BETWEEN operator selects values within a given range and is inclusive: begin and end values are included. The values can be numbers, text, or dates. In the following example, we filter rows from the ecom table where the visit count is between 1 and 3, and the device used to visit the website is mobile. dbGetQuery(con, &quot;SELECT * FROM ecom WHERE n_visit BETWEEN 1 AND 3 AND device = &#39;mobile&#39;&quot;) ## id referrer device bouncers n_visit n_pages duration ## 1 9 bing mobile 0 3 19 209 ## 2 32 direct mobile 1 2 1 501 ## 3 36 bing mobile 0 1 1 25 ## 4 38 yahoo mobile 1 3 1 700 ## country purchase order_items order_value ## 1 Netherlands 0 0 0 ## 2 El Salvador 0 0 0 ## 3 Ireland 0 10 1885 ## 4 Canada 0 0 0 ## [ reached getOption(&quot;max.print&quot;) -- omitted 86 rows ] 3.10 IN The IN operator allows us to specify multiple values in a WHERE clause. It is a shorthand for multiple OR conditions. In the below example, we filter rows from the ecom table where the visit count is either 2 or 4 or 6 or 8 or 10. Instead of using multiple OR conditions, we use the IN operator. dbGetQuery(con, &quot;SELECT * FROM ecom WHERE n_visit IN (2, 4, 6, 8, 10)&quot;) ## id referrer device bouncers n_visit n_pages duration ## 1 1 google laptop 1 10 1 693 ## 2 7 yahoo mobile 1 10 1 75 ## 3 8 direct mobile 1 10 1 908 ## 4 10 google mobile 1 6 1 208 ## country purchase order_items order_value ## 1 Czech Republic 0 0 0 ## 2 Bangladesh 0 0 0 ## 3 Indonesia 0 0 0 ## 4 Czech Republic 0 0 0 ## [ reached getOption(&quot;max.print&quot;) -- omitted 443 rows ] 3.11 IS NULL A field with a NULL value is a field with no value. If a field in a table is optional, it is possible to insert a new record or update a record without adding a value to this field. Then, the field will be saved with a NULL value. In the next example, we filter all rows from the ecom table where the device column has NULL values. dbGetQuery(con, &quot;SELECT * FROM ecom WHERE device IS NULL&quot;) ## [1] id referrer device bouncers n_visit ## [6] n_pages duration country purchase order_items ## [11] order_value ## &lt;0 rows&gt; (or 0-length row.names) 3.12 LIKE The LIKE operator is used to search for a specific pattern in a column. There are two wildcards used in conjunction with the LIKE operator: % : represents zero, one, or multiple characters _ : represents a single character In the following example, we filter all rows from the ecom table where the name of the country starts with P. We use % after P to indicate that it can be followed by any number or type of characters. dbGetQuery(con, &quot;SELECT * FROM ecom WHERE country LIKE &#39;P%&#39;&quot;) ## id referrer device bouncers n_visit n_pages duration ## 1 5 yahoo mobile 1 9 1 955 ## 2 14 yahoo tablet 0 5 8 80 ## 3 17 bing tablet 0 5 16 368 ## 4 43 bing laptop 1 0 1 456 ## country purchase order_items order_value ## 1 Poland 0 0 0 ## 2 Philippines 0 2 362 ## 3 Peru 1 6 1049 ## 4 Portugal 0 0 0 ## [ reached getOption(&quot;max.print&quot;) -- omitted 135 rows ] Let us look at another example where we filter all rows from the ecom table where the name of the country should follow the below conditions: name can start with any character the second character must be o it can have any type or number of characters after the second character dbGetQuery(con, &quot;SELECT * FROM ecom WHERE country LIKE &#39;_o%&#39;&quot;) ## id referrer device bouncers n_visit n_pages duration ## 1 5 yahoo mobile 1 9 1 955 ## 2 6 yahoo laptop 0 5 5 135 ## 3 19 social tablet 0 7 10 290 ## 4 30 yahoo mobile 0 8 9 225 ## country purchase order_items order_value ## 1 Poland 0 0 0 ## 2 South Africa 0 0 0 ## 3 Colombia 1 9 1304 ## 4 Colombia 0 0 0 ## [ reached getOption(&quot;max.print&quot;) -- omitted 117 rows ] "],
["sql2.html", "Chapter 4 SQL Advanced 4.1 Introduction 4.2 Libraries, Code &amp; Data 4.3 Set Up 4.4 Aggregate 4.5 Alias 4.6 Order By 4.7 Group By", " Chapter 4 SQL Advanced 4.1 Introduction In this chapter, we will learn to aggregate data order data and group data 4.2 Libraries, Code &amp; Data We will use the following libraries in this chapter: DBI RSQLite dbplyr All the data sets used in this chapter can be found here and code can be downloaded from here. 4.3 Set Up ecom &lt;- readr::read_csv(&#39;https://raw.githubusercontent.com/rsquaredacademy/datasets/master/web.csv&#39;) con &lt;- DBI::dbConnect(RSQLite::SQLite(), &quot;:memory:&quot;) copy_to(con, ecom) 4.4 Aggregate Let us combine the aggregate statements with WHERE statement to filter data. SUM() : returns the total sum of a numeric column dbGetQuery(con, &quot;SELECT SUM(n_visit) FROM ecom&quot;) ## SUM(n_visit) ## 1 4972 dbGetQuery(con, &quot;SELECT SUM(n_visit) FROM ecom WHERE n_visit &gt; 5&quot;) ## SUM(n_visit) ## 1 3574 AVG() : returns the average value of a numeric column dbGetQuery(con, &quot;SELECT AVG(n_visit) FROM ecom&quot;) ## AVG(n_visit) ## 1 4.972 dbGetQuery(con, &quot;SELECT AVG(n_visit) FROM ecom WHERE country LIKE &#39;P%&#39;&quot;) ## AVG(n_visit) ## 1 5.079137 MAX() : returns the largest value of the selected column dbGetQuery(con, &quot;SELECT MAX(n_visit) FROM ecom&quot;) ## MAX(n_visit) ## 1 10 dbGetQuery(con, &quot;SELECT MAX(n_visit) FROM ecom WHERE device == &#39;tablet&#39;&quot;) ## MAX(n_visit) ## 1 10 MIN() : returns the smallest value of the selected column dbGetQuery(con, &quot;SELECT MIN(n_visit) FROM ecom&quot;) ## MIN(n_visit) ## 1 0 dbGetQuery(con, &quot;SELECT MIN(n_visit) FROM ecom WHERE duration BETWEEN 600 AND 900&quot;) ## MIN(n_visit) ## 1 0 4.5 Alias SQL aliases are used to give a table, or a column in a table, a temporary name. They are often used to make column names more readable. An alias only exists for the duration of the query. Below are a few examples: dbGetQuery(con, &quot;SELECT AVG(n_visit) AS avg_mobile FROM ecom WHERE device == &#39;mobile&#39;&quot;) ## avg_mobile ## 1 5.479651 dbGetQuery(con, &quot;SELECT MAX(n_visit) AS max_visit FROM ecom&quot;) ## max_visit ## 1 10 dbGetQuery(con, &quot;SELECT MIN(duration) AS min_duration FROM ecom&quot;) ## min_duration ## 1 10 4.6 Order By The ORDER BY keyword is used to sort the records in ascending or descending order. By default, the records are sorted in ascending order. Use the DESC keyword if you want to sort the records in descending order, dbGetQuery(con, &quot;SELECT * FROM ecom ORDER BY country&quot;) ## id referrer device bouncers n_visit n_pages duration ## 1 232 social laptop 0 8 2 60 ## 2 299 yahoo laptop 0 10 18 180 ## 3 570 social laptop 1 2 1 274 ## 4 677 direct tablet 1 10 1 682 ## country purchase order_items order_value ## 1 Afghanistan 0 0 0 ## 2 Afghanistan 0 0 0 ## 3 Afghanistan 0 0 0 ## 4 Afghanistan 0 0 0 ## [ reached getOption(&quot;max.print&quot;) -- omitted 996 rows ] dbGetQuery(con, &quot;SELECT * FROM ecom ORDER BY duration&quot;) ## id referrer device bouncers n_visit n_pages duration ## 1 236 yahoo tablet 1 5 1 10 ## 2 615 social laptop 1 1 1 10 ## 3 392 yahoo laptop 0 0 1 12 ## 4 688 social mobile 1 2 1 12 ## country purchase order_items order_value ## 1 Poland 0 0 0 ## 2 Finland 0 0 0 ## 3 Indonesia 0 0 0 ## 4 Botswana 0 0 0 ## [ reached getOption(&quot;max.print&quot;) -- omitted 996 rows ] dbGetQuery(con, &quot;SELECT * FROM ecom ORDER BY n_visit DESC&quot;) ## id referrer device bouncers n_visit n_pages duration ## 1 1 google laptop 1 10 1 693 ## 2 7 yahoo mobile 1 10 1 75 ## 3 8 direct mobile 1 10 1 908 ## 4 29 google mobile 1 10 1 338 ## country purchase order_items order_value ## 1 Czech Republic 0 0 0 ## 2 Bangladesh 0 0 0 ## 3 Indonesia 0 0 0 ## 4 Russia 0 0 0 ## [ reached getOption(&quot;max.print&quot;) -- omitted 996 rows ] 4.7 Group By The GROUP BY statement is used with aggregate functions (COUNT, MAX, MIN, SUM, AVG) to group the result by one or more columns. dbGetQuery(con, &quot;SELECT device, count(*) AS visits FROM ecom GROUP BY device ORDER by visits DESC&quot;) ## device visits ## 1 mobile 344 ## 2 tablet 331 ## 3 laptop 325 dbGetQuery(con, &quot;SELECT device, MAX(duration) AS max_duration FROM ecom GROUP BY device ORDER by max_duration DESC&quot;) ## device max_duration ## 1 tablet 999 ## 2 laptop 997 ## 3 mobile 994 "]
]
